// Schéma Prisma — IT-Inventory
// Base de données PostgreSQL pour la gestion de stock informatique

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Rôles utilisateur
enum Role {
  ADMIN
  TECHNICIAN
}

// Types de mouvement de stock
enum MovementType {
  ENTRY
  EXIT
  ADJUSTMENT
  TRANSFER
}

// Utilisateur / Technicien IT
model User {
  id           String          @id @default(cuid())
  technicianId String          @unique // Format : T000000
  name         String
  password     String
  role         Role            @default(TECHNICIAN)
  isActive     Boolean         @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  movements    StockMovement[]
  auditLogs    AuditLog[]
}

// Site de stockage
model Site {
  id            String          @id @default(cuid())
  name          String          @unique // Ex: "Stock 5ème", "Stock 8ème"
  address       String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  stocks        ArticleStock[]
  movementsFrom StockMovement[] @relation("fromSite")
  movementsTo   StockMovement[] @relation("toSite")
}

// Article du stock informatique
model Article {
  id          String          @id @default(cuid())
  reference   String          @unique
  name        String
  description String?
  category    String
  codeFamille String?
  articleType String?
  sousType    String?
  emplacement String?
  brand       String?
  model       String?
  barcode     String?         @unique
  imageUrl    String?
  unit        String          @default("pièce")
  minStock    Int             @default(0)
  isArchived  Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  stocks      ArticleStock[]
  movements   StockMovement[]
  auditLogs   AuditLog[]
}

// Stock d'un article sur un site donné
model ArticleStock {
  id        String  @id @default(cuid())
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId String
  site      Site    @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId    String
  quantity  Int     @default(0)

  @@unique([articleId, siteId])
}

// Mouvement de stock (entrée, sortie, ajustement, transfert)
model StockMovement {
  id         String       @id @default(cuid())
  type       MovementType
  quantity   Int
  reason     String?
  article    Article      @relation(fields: [articleId], references: [id])
  articleId  String
  fromSite   Site?        @relation("fromSite", fields: [fromSiteId], references: [id])
  fromSiteId String?
  toSite     Site?        @relation("toSite", fields: [toSiteId], references: [id])
  toSiteId   String?
  user       User         @relation(fields: [userId], references: [id])
  userId     String
  createdAt  DateTime     @default(now())
}

// Journal d'audit — traçabilité complète des modifications
model AuditLog {
  id         String   @id @default(cuid())
  action     String   // Ex: "CREATE_ARTICLE", "UPDATE_ARTICLE", "DELETE_ARTICLE"
  entityType String   // Ex: "Article", "User", "Site"
  entityId   String
  oldValue   Json?
  newValue   Json?
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  article    Article? @relation(fields: [articleId], references: [id])
  articleId  String?
  createdAt  DateTime @default(now())
}
